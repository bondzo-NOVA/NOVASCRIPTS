if skeletonEspEnabled then
    for player, data in pairs(Skeletons) do
        if data.Character and data.Character:FindFirstChild("Head") then
            local h = data.Character:FindFirstChild("Humanoid")
            if h and h.Health > 0 then
                local head = data.Character.Head
                local _, headOnScreen = camera:WorldToViewportPoint(head.Position)
                if headOnScreen then
                    local connections = (data.RigType == Enum.HumanoidRigType.R6) and R6Connections or R15Connections
                    for i, parts in ipairs(connections) do
                        local part0 = data.Character:FindFirstChild(parts[1])
                        local part1 = data.Character:FindFirstChild(parts[2])
                        local line = data.Lines[i]
                        if part0 and part1 then
                            local pos0, onScreen0 = camera:WorldToViewportPoint(part0.Position)
                            local pos1, onScreen1 = camera:WorldToViewportPoint(part1.Position)
                            if onScreen0 and onScreen1 then
                                line.From = Vector2.new(pos0.X, pos0.Y)
                                line.To = Vector2.new(pos1.X, pos1.Y)
                                line.Visible = true
                            else
                                line.Visible = false
                            end
                        else
                            line.Visible = false
                        end
                    end
                else
                    for _, line in pairs(data.Lines) do
                        line.Visible = false
                    end
                end
            else
                for _, line in pairs(data.Lines) do
                    line.Visible = false
                end
            end
        else
            for _, line in pairs(data.Lines) do
                line.Visible = false
            end
        end
    end
else
    for _, playerSkeleton in pairs(Skeletons) do
        if playerSkeleton then
            for _, line in pairs(playerSkeleton.Lines) do
                line.Visible = false
            end
        end
    end
end
